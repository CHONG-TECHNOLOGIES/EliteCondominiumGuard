# Device Configuration & Storage Sync Strategy

**Elite CondoGuard - Comprehensive Guide**
**Last Updated:** 2025-12-11
**Version:** 1.0

---

## Table of Contents

1. [Overview](#overview)
2. [Storage Architecture](#storage-architecture)
3. [Device Configuration Flow](#device-configuration-flow)
4. [All Possible Scenarios](#all-possible-scenarios)
5. [Implementation Details](#implementation-details)
6. [Offline Emergency Configuration](#offline-emergency-configuration)
7. [Sync Strategy](#sync-strategy)
8. [Troubleshooting](#troubleshooting)

---

## Overview

Elite CondoGuard uses a **multi-layer storage strategy** with **Central Database as the source of truth**. The application is designed to work in offline-first mode while maintaining data consistency across all storage layers.

### Core Principles

1. **Central Database = Source of Truth**: When online, always defer to Supabase PostgreSQL
2. **Bidirectional Sync**: localStorage â†” IndexedDB â†” Central DB must always be in sync
3. **Graceful Degradation**: Offline mode falls back to local storage (IndexedDB â†’ localStorage)
4. **Recovery Strategy**: Admin-assisted manual configuration when all storage layers fail offline

### Storage Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CENTRAL DATABASE (Supabase)            â”‚
â”‚                  âœ… Source of Truth (Online)            â”‚
â”‚                  PostgreSQL with UUID/SERIAL IDs        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  SYNC BIDIRECTIONAL (when online) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                â”‚
         â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IndexedDB     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  localStorage    â”‚
â”‚  (Dexie.js)     â”‚   SYNC     â”‚  (Fast Access)   â”‚
â”‚  Main Cache     â”‚            â”‚  Backup Layer    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Storage Architecture

### 1. Central Database (Supabase)

**Location**: PostgreSQL (Cloud)
**Role**: Source of truth when online

**Key Tables:**
```sql
-- Devices Table
CREATE TABLE devices (
  id SERIAL PRIMARY KEY,              -- Auto-increment integer
  created_at TIMESTAMPTZ DEFAULT NOW(),
  device_identifier TEXT UNIQUE NOT NULL,  -- UUID generated by client
  device_name TEXT,
  condominium_id INT4 REFERENCES condominiums(id),
  configured_at TIMESTAMPTZ,
  last_seen_at TIMESTAMPTZ,
  status TEXT DEFAULT 'ACTIVE',       -- ACTIVE | INACTIVE | DECOMMISSIONED
  metadata JSONB                      -- Browser info, screen resolution, etc.
);

-- Condominiums Table
CREATE TABLE condominiums (
  id SERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  name TEXT NOT NULL,
  address TEXT,
  logo_url TEXT,
  latitude NUMERIC,
  longitude NUMERIC,
  gps_radius_meters INT,
  status TEXT DEFAULT 'ACTIVE',       -- ACTIVE | INACTIVE
  phone_number TEXT
);
```

### 2. IndexedDB (Dexie.js)

**Location**: Browser IndexedDB
**Role**: Main local cache, offline-first storage

**Schema (Version 7):**
```typescript
// src/services/db.ts
export class CondoDatabase extends Dexie {
  visits!: Table<Visit>;
  units!: Table<Unit>;
  visitTypes!: Table<VisitTypeConfig>;
  serviceTypes!: Table<ServiceTypeConfig>;
  settings!: Table<AppSetting>;      // â† Device configuration stored here
  staff!: Table<Staff>;
  condominiums!: Table<Condominium>;
  restaurants!: Table<Restaurant>;
  sports!: Table<Sport>;
  incidents!: Table<Incident>;
  incidentTypes!: Table<IncidentType>;
  incidentStatuses!: Table<IncidentStatus>;
  devices!: Table<Device>;            // â† Version 7: Device records

  constructor() {
    super('CondoGuardDB');

    // Version 7 migration
    (this as Dexie).version(7).stores({
      devices: 'id, device_identifier, condominium_id, status'
    });
  }
}
```

**Key Settings:**
- `device_condo_details`: Condominium object for this device
- `device_id`: device_identifier (UUID string)

### 3. localStorage

**Location**: Browser localStorage
**Role**: Backup layer, fast access

**Key Items:**
- `condo_guard_device_id`: device_identifier UUID
- `device_condo_backup`: JSON stringified Condominium object

---

## Device Configuration Flow

### Initial Setup (Online - Normal Flow)

**File**: `src/pages/Setup.tsx`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. User navigates to /setup (or redirected)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Setup.tsx loads list of active condominiums         â”‚
â”‚     - Calls: SupabaseService.getActiveCondominiums()    â”‚
â”‚     - Displays grid of condominium cards                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. User selects a condominium                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Calls: api.configureDevice(condoId)                 â”‚
â”‚     Location: src/services/dataService.ts:214           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. VALIDATION: Check if condominium already assigned   â”‚
â”‚     - Get device_identifier from localStorage           â”‚
â”‚     - If empty: generate new UUID via getDeviceId()     â”‚
â”‚     - Query: getActiveDevicesByCondominium(condoId)     â”‚
â”‚     - If devices.length > 0 && device â‰  current:        â”‚
â”‚       â†’ BLOCK with error message                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. REGISTER DEVICE in central database                 â”‚
â”‚     RPC: SupabaseService.registerDevice({               â”‚
â”‚       device_identifier: UUID,                          â”‚
â”‚       device_name: "Tablet - [Condo Name]",             â”‚
â”‚       condominium_id: condoId,                          â”‚
â”‚       metadata: { userAgent, platform, screen... }      â”‚
â”‚     })                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. SAVE LOCALLY (IndexedDB + localStorage)             â”‚
â”‚     IndexedDB:                                          â”‚
â”‚       - settings.put('device_condo_details', condo)     â”‚
â”‚       - settings.put('device_id', deviceId)             â”‚
â”‚     localStorage:                                       â”‚
â”‚       - setItem('condo_guard_device_id', deviceId)      â”‚
â”‚       - setItem('device_condo_backup', JSON(condo))     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. Navigate to /login                                  â”‚
â”‚     Device is now configured âœ…                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration Check on App Start

**File**: `src/App.tsx` - `ConfigGuard` component

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App.tsx renders â†’ ConfigGuard wrapper                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ConfigGuard calls: api.isDeviceConfigured()            â”‚
â”‚  Location: src/services/dataService.ts:61               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIORITY 1: Online Check (Central DB = Source of Truth)â”‚
â”‚  if (this.isBackendHealthy) {                           â”‚
â”‚    1. Get localDeviceId from localStorage               â”‚
â”‚    2. Query central DB by device_identifier             â”‚
â”‚    3. If not found â†’ check by condominium_id in IndexDB â”‚
â”‚    4. If found â†’ SYNC all layers with central data      â”‚
â”‚    5. Return true âœ…                                    â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIORITY 2: Offline Check (IndexedDB)                  â”‚
â”‚  const setting = db.settings.get('device_condo_details')â”‚
â”‚  if (setting) {                                         â”‚
â”‚    - Restore device_id to localStorage if missing       â”‚
â”‚    - Backup condo data to localStorage                  â”‚
â”‚    - Return true âœ…                                     â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIORITY 3: Last Resort (localStorage backup)          â”‚
â”‚  const backup = localStorage.getItem('device_condo_...) â”‚
â”‚  if (backup) {                                          â”‚
â”‚    - Parse JSON                                         â”‚
â”‚    - Restore to IndexedDB                               â”‚
â”‚    - Return true âœ…                                     â”‚
â”‚  }                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NO CONFIGURATION FOUND âŒ                              â”‚
â”‚  Return false â†’ Navigate to /setup (or offline manual)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## All Possible Scenarios

### Scenario Matrix

| # | localStorage | IndexedDB | Online Status | Action |
|---|--------------|-----------|---------------|--------|
| 1 | âœ… Valid     | âœ… Valid  | ğŸŸ¢ Online     | Sync from Central DB â†’ Update all layers |
| 2 | âœ… Valid     | âœ… Valid  | ğŸ”´ Offline    | Use IndexedDB cache (restore to localStorage if needed) |
| 3 | âœ… Valid     | âŒ Empty  | ğŸŸ¢ Online     | Query Central DB â†’ Populate IndexedDB |
| 4 | âœ… Valid     | âŒ Empty  | ğŸ”´ Offline    | Restore from localStorage â†’ IndexedDB |
| 5 | âŒ Empty     | âœ… Valid  | ğŸŸ¢ Online     | Sync from Central DB â†’ Restore localStorage |
| 6 | âŒ Empty     | âœ… Valid  | ğŸ”´ Offline    | Restore from IndexedDB â†’ localStorage |
| 7 | âŒ Empty     | âŒ Empty  | ğŸŸ¢ Online     | Navigate to /setup (normal configuration) |
| 8 | âŒ Empty     | âŒ Empty  | ğŸ”´ Offline    | **OFFLINE EMERGENCY CONFIGURATION** |

---

### Scenario 1: Both Valid + Online (Best Case)

**What Happens:**
```typescript
// dataService.ts:61-131
async isDeviceConfigured(): Promise<boolean> {
  if (this.isBackendHealthy) {
    const localDeviceId = localStorage.getItem('condo_guard_device_id');

    // Query central database by device_identifier
    const centralDevice = await SupabaseService.getDeviceByIdentifier(localDeviceId);

    if (centralDevice && centralDevice.status === 'ACTIVE') {
      // Get full condominium details from central DB
      const correctCondo = await SupabaseService.getCondominium(centralDevice.condominium_id);

      // SYNC: Update ALL storage layers with central data
      await db.settings.put({ key: 'device_condo_details', value: correctCondo });
      await db.settings.put({ key: 'device_id', value: centralDevice.device_identifier });

      localStorage.setItem('condo_guard_device_id', centralDevice.device_identifier);
      localStorage.setItem('device_condo_backup', JSON.stringify(correctCondo));

      console.log('âœ… Synced from central DB');
      return true;
    }
  }
}
```

**Outcome**: âœ… Device configured, all layers synced with central DB

---

### Scenario 2: Both Valid + Offline (Normal Offline Operation)

**What Happens:**
```typescript
// dataService.ts:139-167
// PRIORITY 2: OFFLINE - Check local cache (IndexedDB)
const localSetting = await db.settings.get('device_condo_details');

if (localSetting) {
  // Ensure localStorage has device_id (restore if missing)
  const localDeviceId = localStorage.getItem('condo_guard_device_id');
  if (!localDeviceId) {
    const storedDeviceId = await db.settings.get('device_id');
    if (storedDeviceId) {
      localStorage.setItem('condo_guard_device_id', storedDeviceId.value);
    }
  }

  // Backup to localStorage
  localStorage.setItem('device_condo_backup', JSON.stringify(localSetting.value));

  console.log('âœ… Using offline cache');
  return true;
}
```

**Outcome**: âœ… Device configured from IndexedDB cache, localStorage synced

---

### Scenario 3: localStorage Valid, IndexedDB Empty + Online

**What Happens:**
```typescript
// Same as Scenario 1
// Central DB query by device_identifier from localStorage
// Repopulates IndexedDB with central data
```

**Outcome**: âœ… IndexedDB restored from central DB

---

### Scenario 4: localStorage Valid, IndexedDB Empty + Offline

**What Happens:**
```typescript
// dataService.ts:170-190
// PRIORITY 3: Try localStorage backup as last resort
const backupData = localStorage.getItem('device_condo_backup');
if (backupData) {
  const condoData = JSON.parse(backupData);

  // SYNC: Restore to IndexedDB
  await db.settings.put({ key: 'device_condo_details', value: condoData });

  const localDeviceId = localStorage.getItem('condo_guard_device_id');
  if (localDeviceId) {
    await db.settings.put({ key: 'device_id', value: localDeviceId });
  }

  console.log('âœ… Restored from localStorage backup');
  return true;
}
```

**Outcome**: âœ… IndexedDB restored from localStorage backup

---

### Scenario 5: localStorage Empty, IndexedDB Valid + Online

**What Happens:**
```typescript
// dataService.ts:61-131
// Central DB query, but if not found by device_id...

if (!centralDevice) {
  // Check IndexedDB for previous condominium
  const localSetting = await db.settings.get('device_condo_details');
  if (localSetting) {
    const condoId = localSetting.value.id;

    // Find active devices for this condominium
    const devicesForCondo = await SupabaseService.getActiveDevicesByCondominium(condoId);

    if (devicesForCondo.length === 1) {
      centralDevice = devicesForCondo[0];

      // SYNC: Restore localStorage with central device_identifier
      localStorage.setItem('condo_guard_device_id', centralDevice.device_identifier);
    }
  }
}
```

**Outcome**: âœ… localStorage restored from central DB via condominium lookup

---

### Scenario 6: localStorage Empty, IndexedDB Valid + Offline

**What Happens:**
```typescript
// dataService.ts:139-167
const localSetting = await db.settings.get('device_condo_details');

if (localSetting) {
  // Restore device_id from IndexedDB to localStorage
  const storedDeviceId = await db.settings.get('device_id');
  if (storedDeviceId) {
    localStorage.setItem('condo_guard_device_id', storedDeviceId.value);
  }

  // Backup condominium data
  localStorage.setItem('device_condo_backup', JSON.stringify(localSetting.value));

  console.log('âœ… Restored from IndexedDB while offline');
  return true;
}
```

**Outcome**: âœ… localStorage restored from IndexedDB

---

### Scenario 7: Both Empty + Online (Normal Setup Flow)

**What Happens:**
```typescript
// dataService.ts:197-198
console.warn('âœ— Device not configured - no data found');
return false;

// App.tsx:349
if (!isConfigured) {
  return <Navigate to="/setup" replace />;
}
```

**Outcome**: â¡ï¸ Navigate to /setup for normal configuration

---

### Scenario 8: Both Empty + Offline (EMERGENCY CONFIGURATION) âš ï¸

**What Happens:**
This is the **critical edge case** that requires admin assistance.

**Problem**: Guard cannot configure the device because:
- No internet to load condominium list
- No local cache to restore from
- Cannot verify if device is already assigned in central DB

**Solution**: Offline Emergency Configuration with admin assistance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ConfigGuard detects: !isOnline && !isConfigured        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: Show instructions screen                       â”‚
â”‚  App.tsx:214-267                                        â”‚
â”‚                                                         â”‚
â”‚  Displays:                                              â”‚
â”‚  - device_identifier with copy button                   â”‚
â”‚  - Instructions to contact admin                        â”‚
â”‚  - Button: "ConfiguraÃ§Ã£o Manual"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: Guard contacts admin                           â”‚
â”‚  - Provides device_identifier (UUID)                    â”‚
â”‚  - Admin has internet access                            â”‚
â”‚  - Admin checks central database                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: Admin verifies device status                   â”‚
â”‚                                                         â”‚
â”‚  Query central DB by device_identifier:                 â”‚
â”‚                                                         â”‚
â”‚  CASE A: Device ALREADY ASSIGNED                        â”‚
â”‚    - Admin tells guard: "ID: 123, Nome: Condo Elite"    â”‚
â”‚    - Guard proceeds to manual config form               â”‚
â”‚                                                         â”‚
â”‚  CASE B: Device is NEW (not in database)                â”‚
â”‚    - Admin creates device record in central DB          â”‚
â”‚    - Admin assigns condominium_id                       â”‚
â”‚    - Admin tells guard: "ID: 456, Nome: Condo Luxo"     â”‚
â”‚    - Guard proceeds to manual config form               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: Manual configuration form                      â”‚
â”‚  App.tsx:270-345                                        â”‚
â”‚                                                         â”‚
â”‚  Guard enters:                                          â”‚
â”‚  - Condominium ID (number, provided by admin)           â”‚
â”‚  - Condominium Name (text, provided by admin)           â”‚
â”‚                                                         â”‚
â”‚  Calls: api.configureDeviceOffline(id, name)            â”‚
â”‚  Location: dataService.ts:270-318                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Save offline configuration                     â”‚
â”‚  dataService.ts:270-318                                 â”‚
â”‚                                                         â”‚
â”‚  1. Get device_identifier from localStorage (or new)    â”‚
â”‚                                                         â”‚
â”‚  2. Create minimal Condominium object:                  â”‚
â”‚     {                                                   â”‚
â”‚       id: condoId,                                      â”‚
â”‚       name: condoName,                                  â”‚
â”‚       status: 'ACTIVE',                                 â”‚
â”‚       created_at: new Date().toISOString()              â”‚
â”‚     }                                                   â”‚
â”‚                                                         â”‚
â”‚  3. Save to IndexedDB:                                  â”‚
â”‚     - settings.put('device_condo_details', condo)       â”‚
â”‚     - settings.put('device_id', deviceId)               â”‚
â”‚     - condominiums.put(condo)                           â”‚
â”‚     - devices.put({                                     â”‚
â”‚         device_identifier: deviceId,                    â”‚
â”‚         device_name: "Tablet - [name] (Offline)",       â”‚
â”‚         condominium_id: condoId,                        â”‚
â”‚         configured_at: ISO timestamp,                   â”‚
â”‚         status: 'ACTIVE'                                â”‚
â”‚       })                                                â”‚
â”‚                                                         â”‚
â”‚  4. Save to localStorage:                               â”‚
â”‚     - setItem('condo_guard_device_id', deviceId)        â”‚
â”‚     - setItem('device_condo_backup', JSON(condo))       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6: Navigate to /login                             â”‚
â”‚  Device is configured locally âœ…                        â”‚
â”‚  Will sync when internet is restored                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 7: When internet is restored...                   â”‚
â”‚                                                         â”‚
â”‚  Next app reload â†’ isDeviceConfigured() runs            â”‚
â”‚  - Detects online + has IndexedDB config                â”‚
â”‚  - Queries central DB by device_identifier              â”‚
â”‚  - If found â†’ syncs with central data                   â”‚
â”‚  - If not found â†’ may need admin intervention           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Outcome**: âœ… Device configured offline, will sync when online

---

## Implementation Details

### Key Files Modified

#### 1. `src/services/dataService.ts`

**New Method: `configureDeviceOffline()`**

```typescript
// Lines 270-318
/**
 * OFFLINE EMERGENCY CONFIGURATION
 * Allows admin to manually configure device when offline by providing condominium ID
 * This creates a minimal local configuration that will sync when online
 */
async configureDeviceOffline(condoId: number, condoName: string): Promise<{ success: boolean; error?: string }> {
  try {
    const deviceId = getDeviceIdentifier();

    // Create minimal condominium object for offline use
    const offlineCondo: Condominium = {
      id: condoId,
      name: condoName,
      status: 'ACTIVE',
      created_at: new Date().toISOString()
    };

    // Save to IndexedDB
    await db.settings.put({ key: 'device_condo_details', value: offlineCondo });
    await db.settings.put({ key: 'device_id', value: deviceId });
    await db.condominiums.put(offlineCondo);

    // Create device record in local IndexedDB
    const deviceRecord: Device = {
      device_identifier: deviceId,
      device_name: `Tablet - ${condoName} (Offline Setup)`,
      condominium_id: condoId,
      configured_at: new Date().toISOString(),
      last_seen_at: new Date().toISOString(),
      status: 'ACTIVE',
      metadata: getDeviceMetadata()
    };
    await db.devices.put(deviceRecord);

    // Save to localStorage
    localStorage.setItem('condo_guard_device_id', deviceId);
    localStorage.setItem('device_condo_backup', JSON.stringify(offlineCondo));

    this.currentCondoDetails = offlineCondo;
    this.currentCondoId = condoId;

    console.log('[DataService] âš ï¸ OFFLINE configuration saved - will sync when online');
    return { success: true };
  } catch (error) {
    console.error('[DataService] Offline configuration failed:', error);
    return { success: false, error: "Falha ao configurar dispositivo offline" };
  }
}
```

**Enhanced Method: `isDeviceConfigured()`**

```typescript
// Lines 61-199
async isDeviceConfigured(): Promise<boolean> {
  // PRIORITY 1: If ONLINE, central database is the source of truth
  if (this.isBackendHealthy) {
    let localDeviceId = localStorage.getItem('condo_guard_device_id');
    let centralDevice = null;

    // Try to find device by identifier
    if (localDeviceId) {
      centralDevice = await SupabaseService.getDeviceByIdentifier(localDeviceId);
    }

    // If not found, check by condominium (for recovery scenarios)
    if (!centralDevice) {
      const localSetting = await db.settings.get('device_condo_details');
      if (localSetting) {
        const condoId = localSetting.value.id;
        const devicesForCondo = await SupabaseService.getActiveDevicesByCondominium(condoId);

        if (devicesForCondo.length === 1) {
          centralDevice = devicesForCondo[0];
        }
      }
    }

    if (centralDevice && centralDevice.status === 'ACTIVE') {
      // SYNC: Update all storage layers with central data
      const correctCondo = await SupabaseService.getCondominium(centralDevice.condominium_id);
      const centralDeviceId = centralDevice.device_identifier;

      await db.settings.put({ key: 'device_condo_details', value: correctCondo });
      await db.settings.put({ key: 'device_id', value: centralDeviceId });

      localStorage.setItem('condo_guard_device_id', centralDeviceId);
      localStorage.setItem('device_condo_backup', JSON.stringify(correctCondo));

      return true;
    }

    return false;
  }

  // PRIORITY 2: OFFLINE - Check IndexedDB
  const localSetting = await db.settings.get('device_condo_details');
  if (localSetting) {
    // Restore to localStorage if missing
    const localDeviceId = localStorage.getItem('condo_guard_device_id');
    if (!localDeviceId) {
      const storedDeviceId = await db.settings.get('device_id');
      if (storedDeviceId) {
        localStorage.setItem('condo_guard_device_id', storedDeviceId.value);
      }
    }

    localStorage.setItem('device_condo_backup', JSON.stringify(localSetting.value));
    return true;
  }

  // PRIORITY 3: Try localStorage backup
  const backupData = localStorage.getItem('device_condo_backup');
  if (backupData) {
    const condoData = JSON.parse(backupData);

    await db.settings.put({ key: 'device_condo_details', value: condoData });

    const localDeviceId = localStorage.getItem('condo_guard_device_id');
    if (localDeviceId) {
      await db.settings.put({ key: 'device_id', value: localDeviceId });
    }

    return true;
  }

  // No configuration found
  return false;
}
```

**New Method: `requestPersistentStorage()`**

```typescript
// Lines 38-74
/**
 * Request persistent storage to prevent browser from auto-deleting IndexedDB
 * when disk space is low. Critical for kiosk tablets!
 */
private async requestPersistentStorage() {
  if (!navigator.storage || !navigator.storage.persist) {
    console.warn('[DataService] Persistent storage API not supported');
    return;
  }

  try {
    const isPersisted = await navigator.storage.persisted();

    if (!isPersisted) {
      const granted = await navigator.storage.persist();

      if (granted) {
        console.log('[DataService] âœ… Persistent storage GRANTED');
      } else {
        console.warn('[DataService] âš ï¸ Persistent storage DENIED');
      }
    }

    // Log storage usage
    const estimate = await navigator.storage.estimate();
    const usedMB = (estimate.usage || 0) / 1024 / 1024;
    const quotaMB = (estimate.quota || 0) / 1024 / 1024;

    console.log('[DataService] Storage usage:', {
      used: `${usedMB.toFixed(2)} MB`,
      quota: `${quotaMB.toFixed(2)} MB`
    });
  } catch (err) {
    console.error('[DataService] Error requesting persistent storage:', err);
  }
}
```

---

#### 2. `src/App.tsx`

**Enhanced ConfigGuard Component**

```typescript
// Lines 129-353
const ConfigGuard: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [loading, setLoading] = useState(true);
  const [isConfigured, setIsConfigured] = useState(false);
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [showOfflineConfig, setShowOfflineConfig] = useState(false);
  const [condoId, setCondoId] = useState('');
  const [condoName, setCondoName] = useState('');
  const [configuring, setConfiguring] = useState(false);
  const [error, setError] = useState('');
  const [deviceId, setDeviceId] = useState<string>('');
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    // Load device identifier
    const id = getDeviceIdentifier();
    setDeviceId(id);

    // Check configuration
    api.isDeviceConfigured().then(configured => {
      setIsConfigured(configured);
      setLoading(false);
    });
  }, []);

  const copyDeviceId = () => {
    navigator.clipboard.writeText(deviceId);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const handleOfflineConfiguration = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setConfiguring(true);

    const id = parseInt(condoId);
    if (isNaN(id) || id <= 0) {
      setError('ID do condomÃ­nio invÃ¡lido');
      setConfiguring(false);
      return;
    }

    if (!condoName.trim()) {
      setError('Nome do condomÃ­nio Ã© obrigatÃ³rio');
      setConfiguring(false);
      return;
    }

    const result = await api.configureDeviceOffline(id, condoName.trim());

    if (result.success) {
      setIsConfigured(true);
      window.location.reload();
    } else {
      setError(result.error || 'Erro ao configurar dispositivo');
    }

    setConfiguring(false);
  };

  // Offline + Not Configured â†’ Show instructions
  if (!isConfigured && !isOnline && !showOfflineConfig) {
    return (
      <div>
        <h1>Dispositivo NÃ£o Configurado</h1>

        <ol>
          <li>Contacte o administrador da aplicaÃ§Ã£o</li>
          <li>Informe o device_identifier:
            <div>
              <code>{deviceId}</code>
              <button onClick={copyDeviceId}>
                {copied ? <Check /> : <Copy />}
              </button>
            </div>
          </li>
          <li>O admin verificarÃ¡ na base de dados central:
            <ul>
              <li>Se JÃ ATRIBUÃDO: fornecerÃ¡ ID e nome</li>
              <li>Se NOVO: atribuirÃ¡ e fornecerÃ¡ os dados</li>
            </ul>
          </li>
          <li>Clique em "ConfiguraÃ§Ã£o Manual"</li>
        </ol>

        <button onClick={() => setShowOfflineConfig(true)}>
          ConfiguraÃ§Ã£o Manual
        </button>
      </div>
    );
  }

  // Offline + Manual Config Form
  if (!isConfigured && !isOnline && showOfflineConfig) {
    return (
      <form onSubmit={handleOfflineConfiguration}>
        <input
          type="number"
          value={condoId}
          onChange={(e) => setCondoId(e.target.value)}
          placeholder="ID do CondomÃ­nio"
          required
        />

        <input
          type="text"
          value={condoName}
          onChange={(e) => setCondoName(e.target.value)}
          placeholder="Nome do CondomÃ­nio"
          required
        />

        {error && <div className="error">{error}</div>}

        <button type="button" onClick={() => setShowOfflineConfig(false)}>
          Voltar
        </button>

        <button type="submit" disabled={configuring}>
          {configuring ? 'A configurar...' : 'Configurar'}
        </button>
      </form>
    );
  }

  // Online but not configured â†’ Normal setup
  if (!isConfigured) {
    return <Navigate to="/setup" replace />;
  }

  return <>{children}</>;
};
```

---

#### 3. `src/services/db.ts`

**Added Devices Table (Version 7)**

```typescript
// Lines 22, 61-63, 79
export class CondoDatabase extends Dexie {
  // ... other tables
  devices!: Table<Device>;  // NEW

  constructor() {
    super('CondoGuardDB');

    // ... previous versions

    // Version 7: Add devices table (synced with central database)
    (this as Dexie).version(7).stores({
      devices: 'id, device_identifier, condominium_id, status'
    });
  }

  async clearAllData() {
    // ... clear other tables
    await this.devices.clear();  // NEW
  }
}
```

---

#### 4. `src/services/deviceUtils.ts`

**Enhanced Documentation**

```typescript
// Lines 19-25
/**
 * Gets or creates a unique device identifier.
 * The identifier is stored in localStorage and persists across sessions.
 *
 * IMPORTANT: This should only generate a NEW UUID during initial device setup.
 * After configuration, the device ID from the central database should be used.
 */
export function getDeviceIdentifier(): string {
  let deviceId = localStorage.getItem(DEVICE_ID_KEY);

  if (!deviceId) {
    deviceId = generateUUID();
    localStorage.setItem(DEVICE_ID_KEY, deviceId);
    console.log('[DeviceUtils] Generated NEW device ID (temporary until configured)');
  }

  return deviceId;
}
```

---

## Offline Emergency Configuration

### When Does It Trigger?

**Conditions:**
1. `navigator.onLine === false` (No internet)
2. `localStorage.getItem('condo_guard_device_id') === null` (No device ID)
3. `db.settings.get('device_condo_details') === null` (No IndexedDB config)
4. `localStorage.getItem('device_condo_backup') === null` (No backup)

### User Flow

```
Guard arrives at unconfigured tablet (offline)
    â†“
App shows: "Dispositivo NÃ£o Configurado"
    â†“
Instructions screen displays device_identifier
    â†“
Guard calls/messages admin with device_identifier
    â†“
Admin checks central database (has internet)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin Query:                            â”‚
â”‚  SELECT * FROM devices                   â”‚
â”‚  WHERE device_identifier = '{UUID}';     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â–¼                 â–¼
FOUND              NOT FOUND
Already Assigned   New Device
    â”‚                 â”‚
    â–¼                 â–¼
SELECT c.id,       INSERT INTO devices
  c.name             VALUES (...)
FROM condominiums  RETURNING id,
  JOIN devices       condominium_id
    â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
Admin tells guard:
"ID: 123, Nome: Condominio Elite"
    â†“
Guard clicks "ConfiguraÃ§Ã£o Manual"
    â†“
Guard enters ID and Name
    â†“
Clicks "Configurar"
    â†“
configureDeviceOffline() saves to:
- IndexedDB settings
- IndexedDB devices
- IndexedDB condominiums
- localStorage
    â†“
Navigate to /login
    â†“
âœ… Device configured locally
    â†“
When internet restored â†’ Syncs with central DB
```

### Important Notes

1. **Device Identifier is Critical**: Without it, admin cannot verify device status
2. **Admin Must Have Internet**: This process requires admin access to central database
3. **Two Scenarios**:
   - Device already registered â†’ Admin provides existing data
   - New device â†’ Admin creates record first, then provides data
4. **Sync on Recovery**: When internet is restored, `isDeviceConfigured()` will sync with central DB

---

## Sync Strategy

### Bidirectional Sync Points

**1. Normal Configuration (Online)**
```
Central DB â†’ IndexedDB âœ…
Central DB â†’ localStorage âœ…
```

**2. Online Recovery (localStorage/IndexedDB empty)**
```
Central DB â†’ IndexedDB âœ…
Central DB â†’ localStorage âœ…
```

**3. Offline Recovery (localStorage empty, IndexedDB populated)**
```
IndexedDB â†’ localStorage âœ…
```

**4. Offline Recovery (IndexedDB empty, localStorage populated)**
```
localStorage â†’ IndexedDB âœ…
```

**5. Offline Emergency Configuration**
```
Manual Input â†’ IndexedDB âœ…
Manual Input â†’ localStorage âœ…
Later: Central DB â†’ IndexedDB + localStorage âœ… (when online)
```

### Sync Validation Rules

**Rule 1: Central DB Always Wins (when online)**
```typescript
if (this.isBackendHealthy) {
  // Query central DB
  const centralDevice = await SupabaseService.getDeviceByIdentifier(deviceId);

  // Overwrite local data with central data
  await db.settings.put({ key: 'device_condo_details', value: centralCondo });
  localStorage.setItem('condo_guard_device_id', centralDeviceId);
}
```

**Rule 2: IndexedDB is Primary Local Storage**
```typescript
// Offline: IndexedDB has priority over localStorage
const localSetting = await db.settings.get('device_condo_details');
if (localSetting) {
  // Use IndexedDB data
  // Restore to localStorage if missing
}
```

**Rule 3: localStorage is Backup/Fast Access**
```typescript
// Always sync IndexedDB changes to localStorage
await db.settings.put({ key: 'device_id', value: deviceId });
localStorage.setItem('condo_guard_device_id', deviceId);
```

**Rule 4: Persistent Storage Protection**
```typescript
// Request persistent storage on app init
await navigator.storage.persist();

// Prevents browser from auto-deleting IndexedDB when disk space low
```

---

## Troubleshooting

### Problem 1: Setup screen appears repeatedly (localStorage cleared)

**Cause**: `localStorage.clear()` or browser privacy mode cleared device_identifier

**Diagnosis**:
```javascript
// In browser console
localStorage.getItem('condo_guard_device_id')
// null âŒ
```

**Solution**:
1. If **online**: App will query central DB by checking IndexedDB for condominium
2. If **offline**: App will restore from IndexedDB to localStorage
3. If **both empty + online**: Navigate to /setup
4. If **both empty + offline**: Offline emergency configuration

---

### Problem 2: "Condominium already assigned" error

**Cause**: Attempting to configure a condominium that's already assigned to another active device

**Diagnosis**:
```sql
SELECT * FROM devices
WHERE condominium_id = 123
  AND status = 'ACTIVE';
-- Returns multiple rows âŒ
```

**Solution**:
- **Admin Action**: Deactivate old devices via Admin Panel â†’ Devices
- **Or**: Use `forceConfigureDevice()` (requires admin authentication)

---

### Problem 3: Offline configuration doesn't sync when online

**Cause**: Device record not found in central database by device_identifier

**Diagnosis**:
```sql
SELECT * FROM devices
WHERE device_identifier = '{UUID-from-localStorage}';
-- No rows returned âŒ
```

**Solution**:
1. Admin manually creates device record in central database
2. Restart app â†’ `isDeviceConfigured()` will find device and sync
3. **Prevention**: During offline emergency config, admin should create device record

---

### Problem 4: IndexedDB cleared unexpectedly

**Cause**: Browser auto-deletion when disk space low (if persistent storage denied)

**Diagnosis**:
```javascript
// Check if persistent storage granted
const isPersisted = await navigator.storage.persisted();
// false âŒ
```

**Solution**:
1. **Automatic**: App requests persistent storage on startup
2. **Manual**: User must grant permission in browser settings
3. **Recovery**: If localStorage still has backup, will restore to IndexedDB

---

### Problem 5: Sync conflict (local data â‰  central data)

**Cause**: Device was reconfigured in central DB while offline

**Resolution Strategy**:
```typescript
// Central DB always wins
if (this.isBackendHealthy) {
  const centralDevice = await getDeviceByIdentifier(localDeviceId);

  if (centralDevice.condominium_id !== this.currentCondoId) {
    console.warn('Sync conflict detected - using central DB data');

    // Overwrite local with central
    const correctCondo = await getCondominium(centralDevice.condominium_id);
    await db.settings.put({ key: 'device_condo_details', value: correctCondo });

    this.currentCondoId = correctCondo.id;
  }
}
```

---

### Problem 6: device_identifier changed after reinstall

**Cause**: Browser cache/data cleared, new UUID generated

**Impact**: Central DB has old device_identifier, app generates new one

**Solution**:
1. **Admin Query**: Find device by condominium_id
   ```sql
   SELECT * FROM devices
   WHERE condominium_id = 123
     AND status = 'ACTIVE';
   ```
2. **Admin Action**: Update device_identifier in central DB to new UUID
   ```sql
   UPDATE devices
   SET device_identifier = '{new-UUID}'
   WHERE id = {device-id};
   ```
3. **Or**: Deactivate old device, configure as new device

---

## Best Practices

### For Admins

1. **Always verify device_identifier** before manual offline configuration
2. **Create device records** in central DB during offline emergency setup
3. **Monitor device heartbeats** (last_seen_at) to detect offline devices
4. **Deactivate decommissioned devices** instead of deleting

### For Guards

1. **Contact admin immediately** if offline + unconfigured
2. **Provide exact device_identifier** (use copy button)
3. **Enter data carefully** during manual configuration
4. **Don't clear browser cache/data** on configured tablets

### For Developers

1. **Never clear localStorage** without also clearing IndexedDB
2. **Always sync bidirectionally** when updating device configuration
3. **Test offline scenarios** thoroughly (airplane mode testing)
4. **Log all sync operations** for debugging

---

## Summary

### Storage Layer Priorities

**Online Mode:**
1. Central Database (PostgreSQL) â† **Source of Truth**
2. IndexedDB (Dexie.js) â† Synced from Central
3. localStorage â† Synced from Central

**Offline Mode:**
1. IndexedDB (Dexie.js) â† **Primary Cache**
2. localStorage â† Backup/Fast Access
3. Central Database â† Unavailable

### Configuration States

| State | Online | Offline |
|-------|--------|---------|
| âœ… Configured | Sync from Central DB | Use IndexedDB cache |
| âŒ Not Configured | Navigate to /setup | Emergency manual config |

### Critical Features

âœ… **Persistent Storage API** prevents data loss
âœ… **Bidirectional Sync** ensures consistency
âœ… **Offline Emergency Configuration** handles edge case
âœ… **Central DB Source of Truth** prevents conflicts
âœ… **Multiple Recovery Strategies** for resilience

---

**End of Documentation**

For technical support, contact: Chong Technologies
Project: Elite CondoGuard v0.0.0 (Alpha)
